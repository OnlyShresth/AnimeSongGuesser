<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AnimeSongGuesser - Random Songs Working</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(135deg, #14213d 0%, #000000 100%);
      color: white;
      margin: 0;
      padding: 20px;
      min-height: 100vh;
    }

    .container {
      max-width: 1000px;
      margin: 0 auto;
    }

    .section {
      display: block;
      margin: 20px 0;
      padding: 30px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      border: 2px solid #fca311;
    }

    .section.hidden {
      display: none !important;
    }

    .menu-item {
      background: rgba(252, 163, 17, 0.2);
      border: 2px solid #fca311;
      border-radius: 10px;
      padding: 30px;
      margin: 20px 0;
      cursor: pointer;
      text-align: center;
      font-size: 1.2em;
    }

    .menu-item:hover {
      background: rgba(252, 163, 17, 0.4);
    }

    .btn {
      background: #fca311;
      color: #14213d;
      border: none;
      padding: 15px 30px;
      border-radius: 25px;
      cursor: pointer;
      font-size: 1.1em;
      font-weight: bold;
      margin: 10px;
    }

    .btn:hover {
      background: #ffb347;
      transform: scale(1.05);
    }

    .game-controls {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 30px;
      margin: 30px 0;
      flex-wrap: wrap;
    }

    .play-btn {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: #fca311;
      border: none;
      color: #14213d;
      font-size: 2em;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .timer {
      font-size: 3em;
      font-weight: bold;
      color: #fca311;
    }

    .guess-input {
      width: 100%;
      padding: 15px;
      font-size: 1.2em;
      border-radius: 25px;
      border: 2px solid #fca311;
      background: rgba(0, 0, 0, 0.3);
      color: white;
      text-align: center;
    }

    .messages {
      height: 200px;
      overflow-y: auto;
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid #fca311;
      border-radius: 10px;
      padding: 15px;
      margin: 20px 0;
    }

    .message {
      margin: 10px 0;
      padding: 10px;
      border-radius: 5px;
      background: rgba(252, 163, 17, 0.2);
    }

    .loading {
      text-align: center;
      color: #fca311;
      font-size: 1.2em;
    }

    .status-display {
      position: fixed;
      top: 10px;
      right: 10px;
      background: rgba(0, 0, 0, 0.8);
      padding: 10px;
      border-radius: 5px;
      font-family: monospace;
      font-size: 12px;
      max-width: 300px;
    }
  </style>
</head>
<body>
  <div class="status-display" id="statusDisplay">
    Status: Initializing...
  </div>

  <div class="container">
    <h1 style="text-align: center; color: #fca311; font-size: 3em; margin-bottom: 30px;">
      üéµ AnimeSongGuesser
    </h1>

    <!-- MAIN MENU SECTION -->
    <div class="section" id="mainMenuSection">
      <h2 style="text-align: center; color: #fca311;">Main Menu</h2>
      
      <div class="section" style="text-align: center;">
        <h3>Choose Your Name</h3>
        <input type="text" id="playerName" placeholder="Enter your name..." 
               style="padding: 10px; font-size: 1.1em; border-radius: 20px; border: 1px solid #fca311; background: rgba(0,0,0,0.3); color: white; text-align: center;">
      </div>

      <div class="menu-item" id="practiceBtn">
        <h3>üéØ Practice Mode</h3>
        <p>Practice with random anime songs!</p>
      </div>
    </div>

    <!-- GAME INTERFACE SECTION -->
    <div class="section hidden" id="gameInterfaceSection">
      <h2 style="text-align: center; color: #fca311;">Game In Progress</h2>
      
      <div style="text-align: center; margin: 20px 0;">
        <h3>Song <span id="currentSong">1</span> of 10</h3>
        <p>Score: <span id="scoreDisplay">0</span> points</p>
      </div>

      <div class="game-controls">
        <button class="play-btn" id="playBtn">‚ñ∂Ô∏è</button>
        <div class="timer" id="timer">5</div>
        <button class="btn" id="extendBtn">‚è∞ Extend (+5s, -5pts)</button>
      </div>

      <div style="margin: 30px 0;">
        <h3>Make Your Guess:</h3>
        <input type="text" class="guess-input" id="guessInput" 
               placeholder="Song title, anime name, or artist...">
      </div>

      <div class="messages" id="messages">
        <div class="message">üéµ Game started! Click play to begin...</div>
      </div>

      <div style="text-align: center;">
        <button class="btn" id="backToMenuBtn">üè† Back to Menu</button>
      </div>

      <!-- HIDDEN AUDIO ELEMENT -->
      <audio id="audioPlayer" style="display: none;" controls></audio>
    </div>
  </div>

  <script>
    console.log('üéµ Script starting...');

    let gameState = {
      playerName: 'Anonymous',
      currentSong: 1,
      totalSongs: 10,
      score: 0,
      timer: 5,
      isPlaying: false,
      hasExtended: false,
      songs: [],
      currentTimerInterval: null,
      audioController: null
    };

    function updateStatus(message) {
      console.log('üìä Status:', message);
      const statusEl = document.getElementById('statusDisplay');
      if (statusEl) {
        statusEl.innerHTML = `Status: ${message}<br>Current Song: ${gameState.currentSong}<br>Score: ${gameState.score}<br>Playing: ${gameState.isPlaying}`;
      }
    }

    // FIXED: Fetch random anime from Jikan API
    async function fetchRandomAnimeList() {
      console.log('üîç Fetching random anime from API...');
      updateStatus('Fetching random anime...');
      
      try {
        // Get random anime using Jikan API
        const response = await fetch('https://api.jikan.moe/v4/random/anime');
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        console.log('‚úÖ API Response:', data);
        
        return data.data;
      } catch (error) {
        console.error('‚ùå API Error:', error);
        throw error;
      }
    }

    // FIXED: Create randomized song list from anime data
    async function createRandomSongs(count = 10) {
      console.log(`üé≤ Creating ${count} random songs...`);
      updateStatus('Creating random songs...');
      
      const songs = [];
      const animeTypes = ['TV', 'Movie', 'OVA', 'Special'];
      const songTypes = ['Opening', 'Ending', 'Insert Song', 'OST'];
      
      // List of popular anime for fallback
      const popularAnime = [
        { title: "Attack on Titan", anime: "Shingeki no Kyojin", artist: "Linked Horizon" },
        { title: "Unravel", anime: "Tokyo Ghoul", artist: "TK from Ling tosite sigure" },
        { title: "Cruel Angel's Thesis", anime: "Neon Genesis Evangelion", artist: "Yoko Takahashi" },
        { title: "Tank!", anime: "Cowboy Bebop", artist: "The Seatbelts" },
        { title: "Gurenge", anime: "Demon Slayer", artist: "LiSA" },
        { title: "We Are!", anime: "One Piece", artist: "Hiroshi Kitadani" },
        { title: "Again", anime: "Fullmetal Alchemist Brotherhood", artist: "YUI" },
        { title: "Silhouette", anime: "Naruto Shippuden", artist: "KANA-BOON" },
        { title: "My War", anime: "Attack on Titan Final Season", artist: "Shinsei Kamattechan" },
        { title: "Sono Chi no Sadame", anime: "JoJo's Bizarre Adventure", artist: "Hiroaki Tommy Tominaga" },
        { title: "Blue Bird", anime: "Naruto Shippuden", artist: "Ikimono-gakari" },
        { title: "Crossing Field", anime: "Sword Art Online", artist: "LiSA" },
        { title: "Colors", anime: "Code Geass", artist: "FLOW" },
        { title: "Guren no Yumiya", anime: "Attack on Titan", artist: "Linked Horizon" },
        { title: "Renai Circulation", anime: "Bakemonogatari", artist: "Kana Hanazawa" }
      ];
      
      try {
        // Try to fetch some real anime data for variety
        for (let i = 0; i < Math.min(count, 5); i++) {
          try {
            const anime = await fetchRandomAnimeList();
            if (anime && anime.title) {
              songs.push({
                title: `${songTypes[Math.floor(Math.random() * songTypes.length)]} Song`,
                anime: anime.title,
                artist: 'Various Artists',
                // Use a working audio placeholder
                audio: 'https://www.soundjay.com/misc/sounds/bell-ringing-05.wav',
                type: anime.type || 'TV',
                year: anime.year || new Date().getFullYear()
              });
            }
          } catch (error) {
            console.warn('‚ö†Ô∏è Failed to fetch anime, using fallback');
            break;
          }
        }
      } catch (error) {
        console.warn('‚ö†Ô∏è API unavailable, using popular songs');
      }
      
      // Fill remaining slots with popular anime (randomized)
      const shuffledPopular = popularAnime.sort(() => Math.random() - 0.5);
      while (songs.length < count) {
        const song = shuffledPopular[songs.length % shuffledPopular.length];
        songs.push({
          ...song,
          // Use working audio placeholder
          audio: 'https://www.soundjay.com/misc/sounds/bell-ringing-05.wav',
          type: animeTypes[Math.floor(Math.random() * animeTypes.length)],
          year: 2000 + Math.floor(Math.random() * 24)
        });
      }
      
      // FIXED: Shuffle the final song list for randomization
      const shuffledSongs = songs.sort(() => Math.random() - 0.5);
      
      console.log(`‚úÖ Created ${shuffledSongs.length} random songs:`, shuffledSongs);
      return shuffledSongs;
    }

    function showMainMenu() {
      console.log('üè† Showing main menu');
      updateStatus('Showing main menu');
      
      const mainMenu = document.getElementById('mainMenuSection');
      const gameInterface = document.getElementById('gameInterfaceSection');
      
      if (mainMenu) {
        mainMenu.classList.remove('hidden');
        console.log('‚úÖ Main menu shown');
      }
      
      if (gameInterface) {
        gameInterface.classList.add('hidden');
        console.log('‚úÖ Game interface hidden');
      }
    }

    function showGameInterface() {
      console.log('üéÆ Showing game interface');
      updateStatus('Showing game interface');
      
      const mainMenu = document.getElementById('mainMenuSection');
      const gameInterface = document.getElementById('gameInterfaceSection');
      
      if (mainMenu) {
        mainMenu.classList.add('hidden');
        console.log('‚úÖ Main menu hidden');
      }
      
      if (gameInterface) {
        gameInterface.classList.remove('hidden');
        console.log('‚úÖ Game interface shown');
      }
      
      updateGameDisplay();
    }

    function updateGameDisplay() {
      const songEl = document.getElementById('currentSong');
      if (songEl) songEl.textContent = gameState.currentSong;
      
      const scoreEl = document.getElementById('scoreDisplay');
      if (scoreEl) scoreEl.textContent = gameState.score;
      
      const timerEl = document.getElementById('timer');
      if (timerEl) timerEl.textContent = gameState.timer;
    }

    function addMessage(text, type = '') {
      console.log(`üí¨ Message: ${text}`);
      
      const messagesContainer = document.getElementById('messages');
      if (!messagesContainer) return;
      
      const messageDiv = document.createElement('div');
      messageDiv.className = 'message';
      messageDiv.textContent = text;
      
      if (type === 'correct') messageDiv.style.background = 'rgba(76, 175, 80, 0.3)';
      if (type === 'wrong') messageDiv.style.background = 'rgba(244, 67, 54, 0.3)';
      if (type === 'loading') messageDiv.style.background = 'rgba(33, 150, 243, 0.3)';
      
      messagesContainer.appendChild(messageDiv);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
      
      const messages = messagesContainer.children;
      if (messages.length > 10) {
        messages[0].remove();
      }
    }

    function setPlayerName() {
      const nameInput = document.getElementById('playerName');
      if (nameInput && nameInput.value.trim()) {
        gameState.playerName = nameInput.value.trim();
      }
      console.log('üë§ Player name:', gameState.playerName);
      updateStatus(`Player: ${gameState.playerName}`);
    }

    // FIXED: Start practice mode with random songs
    async function startPracticeMode() {
      console.log('üéØ Starting practice mode...');
      updateStatus('Starting practice mode');
      
      setPlayerName();
      
      // Show loading message
      showGameInterface();
      addMessage('üîÑ Loading random anime songs...', 'loading');
      
      try {
        // FIXED: Get fresh random songs each time
        gameState.songs = await createRandomSongs(gameState.totalSongs);
        gameState.currentSong = 1;
        gameState.score = 0;
        gameState.timer = 5;
        gameState.isPlaying = false;
        
        // Clear loading message
        const messagesContainer = document.getElementById('messages');
        if (messagesContainer) messagesContainer.innerHTML = '';
        
        addMessage(`üéµ Welcome ${gameState.playerName}! Starting with random songs...`);
        addMessage(`üìÄ Song list updated with ${gameState.songs.length} fresh tracks!`);
        
        startNewSong();
        
      } catch (error) {
        console.error('‚ùå Error starting practice mode:', error);
        addMessage('‚ùå Failed to load songs. Please try again.', 'wrong');
      }
    }

    function startNewSong() {
      console.log(`üéµ Starting song ${gameState.currentSong}`);
      updateStatus(`Round ${gameState.currentSong}`);
      
      if (gameState.currentSong > gameState.totalSongs) {
        endGame();
        return;
      }
      
      gameState.timer = 5;
      gameState.hasExtended = false;
      gameState.isPlaying = false;
      
      if (gameState.currentTimerInterval) {
        clearInterval(gameState.currentTimerInterval);
        gameState.currentTimerInterval = null;
      }
      
      updateGameDisplay();
      
      const playBtn = document.getElementById('playBtn');
      if (playBtn) playBtn.textContent = '‚ñ∂Ô∏è';
      
      const guessInput = document.getElementById('guessInput');
      if (guessInput) {
        guessInput.value = '';
        guessInput.focus();
      }
      
      const song = gameState.songs[gameState.currentSong - 1];
      
      // FIXED: Load audio properly
      if (gameState.audioController) {
        gameState.audioController.src = song.audio;
        gameState.audioController.load();
      }
      
      addMessage(`üéµ Round ${gameState.currentSong}: "${song.anime}" - Click play to hear the song!`);
      addMessage(`üí° This is a ${song.type} from ${song.year || 'Unknown Year'}`);
      
      console.log(`Current song: ${song.title} from ${song.anime}`);
    }

    function toggleAudio() {
      console.log('üîä Toggle audio');
      
      const playBtn = document.getElementById('playBtn');
      if (!playBtn || !gameState.audioController) return;
      
      if (gameState.isPlaying) {
        gameState.audioController.pause();
        gameState.isPlaying = false;
        playBtn.textContent = '‚ñ∂Ô∏è';
        
        if (gameState.currentTimerInterval) {
          clearInterval(gameState.currentTimerInterval);
          gameState.currentTimerInterval = null;
        }
        
        addMessage('‚è∏Ô∏è Audio paused');
        updateStatus('Audio paused');
      } else {
        // FIXED: Handle audio play with error handling
        const playPromise = gameState.audioController.play();
        
        if (playPromise !== undefined) {
          playPromise
            .then(() => {
              gameState.isPlaying = true;
              playBtn.textContent = '‚è∏Ô∏è';
              addMessage('‚ñ∂Ô∏è Audio playing! Make your guess...');
              updateStatus('Audio playing');
              startTimer();
            })
            .catch(error => {
              console.error('‚ùå Audio play failed:', error);
              addMessage('‚ö†Ô∏è Audio failed to play. Browser restrictions may apply.', 'wrong');
              addMessage('üí° Try interacting with the page first, then click play again.');
              
              // Simulate audio playing for game continuity
              gameState.isPlaying = true;
              playBtn.textContent = '‚è∏Ô∏è';
              startTimer();
            });
        } else {
          gameState.isPlaying = true;
          playBtn.textContent = '‚è∏Ô∏è';
          startTimer();
        }
      }
    }

    function startTimer() {
      console.log('‚è±Ô∏è Starting timer');
      
      if (gameState.currentTimerInterval) {
        clearInterval(gameState.currentTimerInterval);
      }
      
      gameState.currentTimerInterval = setInterval(() => {
        gameState.timer--;
        
        const timerEl = document.getElementById('timer');
        if (timerEl) timerEl.textContent = gameState.timer;
        
        updateStatus(`Timer: ${gameState.timer}`);
        
        if (gameState.timer <= 0) {
          clearInterval(gameState.currentTimerInterval);
          gameState.currentTimerInterval = null;
          timeUp();
        }
      }, 1000);
    }

    function makeGuess() {
      const guessInput = document.getElementById('guessInput');
      if (!guessInput) return;
      
      const guess = guessInput.value.trim();
      if (!guess) return;
      
      console.log(`ü§î Guess: ${guess}`);
      
      const currentSong = gameState.songs[gameState.currentSong - 1];
      const isCorrect = checkGuess(guess, currentSong);
      
      if (isCorrect) {
        const points = gameState.hasExtended ? 5 : 10;
        gameState.score += points;
        
        addMessage(`‚úÖ "${guess}" - CORRECT! +${points} points`, 'correct');
        addMessage(`üéµ "${currentSong.title}" from ${currentSong.anime} by ${currentSong.artist}`);
        
        gameState.isPlaying = false;
        if (gameState.audioController) gameState.audioController.pause();
        
        if (gameState.currentTimerInterval) {
          clearInterval(gameState.currentTimerInterval);
          gameState.currentTimerInterval = null;
        }
        
        updateGameDisplay();
        updateStatus(`Correct! Score: ${gameState.score}`);
        
        setTimeout(() => {
          nextSong();
        }, 3000);
      } else {
        addMessage(`‚ùå "${guess}" - Try again!`, 'wrong');
      }
      
      guessInput.value = '';
      guessInput.focus();
    }

    function checkGuess(guess, song) {
      const targets = [song.title, song.anime, song.artist];
      const guessLower = guess.toLowerCase();
      
      return targets.some(target => {
        const targetLower = target.toLowerCase();
        return targetLower.includes(guessLower) || guessLower.includes(targetLower);
      });
    }

    function timeUp() {
      console.log('‚è∞ Time up!');
      
      gameState.isPlaying = false;
      const playBtn = document.getElementById('playBtn');
      if (playBtn) playBtn.textContent = '‚ñ∂Ô∏è';
      
      if (gameState.audioController) gameState.audioController.pause();
      
      const currentSong = gameState.songs[gameState.currentSong - 1];
      addMessage('‚è∞ Time\'s up!');
      addMessage(`üéµ Answer: "${currentSong.title}" from ${currentSong.anime} by ${currentSong.artist}`);
      
      setTimeout(() => {
        nextSong();
      }, 4000);
    }

    function nextSong() {
      gameState.currentSong++;
      startNewSong();
    }

    function endGame() {
      console.log('üèÅ Game ended');
      
      const finalScore = gameState.score;
      const maxScore = gameState.totalSongs * 10;
      const accuracy = (finalScore / maxScore * 100).toFixed(1);
      
      addMessage('üéâ GAME COMPLETE!');
      addMessage(`üèÜ Final Score: ${finalScore}/${maxScore} points`);
      addMessage(`üìä Accuracy: ${accuracy}%`);
      addMessage('üé≤ Each game uses different random songs!');
      
      updateStatus(`Game ended: ${finalScore}/${maxScore}`);
      
      setTimeout(() => {
        if (confirm(`Game Complete!\nScore: ${finalScore}/${maxScore}\nAccuracy: ${accuracy}%\n\nPlay again with NEW random songs?`)) {
          startPracticeMode();
        } else {
          showMainMenu();
        }
      }, 3000);
    }

    function extendTime() {
      if (!gameState.hasExtended && gameState.isPlaying) {
        gameState.timer += 5;
        gameState.hasExtended = true;
        gameState.score = Math.max(0, gameState.score - 5);
        
        updateGameDisplay();
        addMessage('‚è∞ Time extended! (-5 points)');
      }
    }

    function backToMenu() {
      console.log('üè† Back to menu');
      
      gameState.isPlaying = false;
      if (gameState.audioController) gameState.audioController.pause();
      
      if (gameState.currentTimerInterval) {
        clearInterval(gameState.currentTimerInterval);
        gameState.currentTimerInterval = null;
      }
      
      gameState.currentSong = 1;
      gameState.score = 0;
      gameState.timer = 5;
      
      showMainMenu();
    }

    // EVENT LISTENERS
    window.onload = function() {
      console.log('üöÄ Window loaded');
      updateStatus('Initializing');
      
      gameState.audioController = document.getElementById('audioPlayer');
      
      const practiceBtn = document.getElementById('practiceBtn');
      if (practiceBtn) {
        practiceBtn.onclick = function() {
          console.log('‚úÖ Practice clicked!');
          startPracticeMode();
        };
      }
      
      const playBtn = document.getElementById('playBtn');
      if (playBtn) {
        playBtn.onclick = function() {
          console.log('‚úÖ Play clicked!');
          toggleAudio();
        };
      }
      
      const extendBtn = document.getElementById('extendBtn');
      if (extendBtn) {
        extendBtn.onclick = function() {
          console.log('‚úÖ Extend clicked!');
          extendTime();
        };
      }
      
      const backBtn = document.getElementById('backToMenuBtn');
      if (backBtn) {
        backBtn.onclick = function() {
          console.log('‚úÖ Back clicked!');
          backToMenu();
        };
      }
      
      const guessInput = document.getElementById('guessInput');
      if (guessInput) {
        guessInput.onkeypress = function(e) {
          if (e.key === 'Enter') {
            makeGuess();
          }
        };
      }
      
      const nameInput = document.getElementById('playerName');
      if (nameInput) {
        nameInput.onkeypress = function(e) {
          if (e.key === 'Enter') {
            setPlayerName();
          }
        };
      }
      
      updateStatus('Ready');
      console.log('‚úÖ All event listeners attached');
      console.log('üéØ Try clicking Practice Mode for RANDOM songs!');
    };

    console.log('üìã Script loaded');
  </script>
</body>
</html>
